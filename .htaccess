# CMSForNerd Security Configuration
# This file provides defense-in-depth protection for Apache servers.
# For Nginx (Laravel Herd), see README.md for equivalent configurations.

# =============================================================================
# 1. DISABLE DIRECTORY BROWSING
# =============================================================================
# MUST: Prevent attackers from seeing directory contents
Options -Indexes

# =============================================================================
# 2. PROTECT SENSITIVE DIRECTORIES
# =============================================================================
# Deny access to includes, tests, vendor, and hidden files
<DirectoryMatch "^\.|\/\.">
    Require all denied
</DirectoryMatch>

<DirectoryMatch "^/(includes|tests|vendor|\.vscode|\.well-known)">
    Require all denied
</DirectoryMatch>

# Exception: Allow .well-known/security.txt (RFC 9116 requirement)
<Files "security.txt">
    Require all granted
</Files>

# =============================================================================
# 3. PROTECT CONFIGURATION FILES
# =============================================================================
# Deny access to composer files, git files, and environment configs
<FilesMatch "(composer\.(json|lock)|\.git.*|\.env.*|\.cursorrules|\.gitattributes)$">
    Require all denied
</FilesMatch>

# =============================================================================
# 4. PREVENT PHP EXECUTION IN UPLOAD DIRECTORIES
# =============================================================================
# If you later add file upload capability, this prevents code execution
<Directory "*/uploads/*">
    php_flag engine off
    <FilesMatch "\.php$">
        Require all denied
    </FilesMatch>
</Directory>

# =============================================================================
# 5. SECURITY HEADERS
# =============================================================================
# Add security headers (these are also in common-headertag.inc for redundancy)
<IfModule mod_headers.c>
    # Prevent clickjacking
    Header always set X-Frame-Options "SAMEORIGIN"
    
    # Prevent MIME-sniffing
    Header always set X-Content-Type-Options "nosniff"
    
    # Enable XSS filter
    Header always set X-XSS-Protection "1; mode=block"
    
    # Referrer policy
    Header always set Referrer-Policy "strict-origin-when-cross-origin"
</IfModule>

# =============================================================================
# 6. BLOCK COMMON EXPLOIT ATTEMPTS
# =============================================================================
# Block access to backup files and common vulnerability scan targets
<FilesMatch "\.(bak|old|backup|swp|~|sql|log|config)$">
    Require all denied
</FilesMatch>

# =============================================================================
# 7. CUSTOM ERROR PAGES
# =============================================================================
# Prevent information disclosure through default error pages
ErrorDocument 403 "Access Denied"
ErrorDocument 404 "Not Found"
ErrorDocument 500 "Server Error"

# =============================================================================
# 8. PERFORMANCE OPTIMIZATIONS
# =============================================================================
# Enable compression for faster page loads
<IfModule mod_deflate.c>
    AddOutputFilterByType DEFLATE text/html text/plain text/xml text/css text/javascript application/javascript application/json
</IfModule>

# Enable browser caching
<IfModule mod_expires.c>
    ExpiresActive On
    ExpiresByType image/jpg "access plus 1 year"
    ExpiresByType image/jpeg "access plus 1 year"
    ExpiresByType image/gif "access plus 1 year"
    ExpiresByType image/png "access plus 1 year"
    ExpiresByType text/css "access plus 1 month"
    ExpiresByType application/javascript "access plus 1 month"
</IfModule>

# =============================================================================
# END OF SECURITY CONFIGURATION
# =============================================================================
